default_platform(:ios)

platform :ios do
  desc "Build iOS release (no upload)"
  lane :build do
    build_number = ENV["BUILD_NUMBER"] || `git rev-list --count HEAD`.strip

    Dir.chdir("../..") do
      sh(
        "flutter", "build", "ios",
        "--release",
        "--build-number=#{build_number}",
        "--dart-define=ENV=prod",
        "--obfuscate",
        "--split-debug-info=build/debug-info",
        # "--no-codesign" # Remove this once signing is configured in Xcode
      )
    end
  end

  desc "Build and upload to TestFlight"
  lane :beta do
    build_number = ENV["BUILD_NUMBER"] || `git rev-list --count HEAD`.strip

    Dir.chdir("../..") do
      sh(
        "flutter", "build", "ios",
        "--release",
        "--build-number=#{build_number}",
        "--dart-define=ENV=prod",
        "--obfuscate",
        "--split-debug-info=build/debug-info"
      )
    end

    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "../build/ios/ipa"
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )
  end
end
