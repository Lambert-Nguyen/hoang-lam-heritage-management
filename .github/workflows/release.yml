name: Fastlane Release

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Release target'
        required: true
        type: choice
        options:
          - android_beta
          - ios_beta
          - both

jobs:
  android_beta:
    name: Android Beta (Play Store Internal)
    if: inputs.target == 'android_beta' || inputs.target == 'both'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Needed for git rev-list --count

    - name: Set up Java
      uses: actions/setup-java@v5
      with:
        distribution: 'zulu'
        java-version: '17'
        cache: 'gradle'

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.41.x'
        channel: 'stable'
        cache: true

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4'
        bundler-cache: true
        working-directory: hoang_lam_app

    - name: Decode keystore
      run: echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/release.keystore
      working-directory: hoang_lam_app

    - name: Create key.properties
      working-directory: hoang_lam_app
      run: |
        cat > android/key.properties << EOF
        storePassword=${{ secrets.KEYSTORE_PASSWORD }}
        keyPassword=${{ secrets.KEY_PASSWORD }}
        keyAlias=hoang-lam-heritage
        storeFile=release.keystore
        EOF

    - name: Get dependencies
      working-directory: hoang_lam_app
      run: flutter pub get

    - name: Generate code
      working-directory: hoang_lam_app
      run: dart run build_runner build --delete-conflicting-outputs

    - name: Build release APK
      working-directory: hoang_lam_app/android
      run: bundle exec fastlane android build_apk
      env:
        BUILD_NUMBER: ${{ github.run_number }}

    - name: Upload APK artifact
      uses: actions/upload-artifact@v6
      with:
        name: app-release
        path: hoang_lam_app/build/app/outputs/flutter-apk/app-release.apk

    # Uncomment when Play Store account is ready:
    # - name: Decode Play Store key
    #   run: echo "${{ secrets.PLAY_STORE_KEY_BASE64 }}" | base64 -d > android/fastlane/play-store-key.json
    #   working-directory: hoang_lam_app
    #
    # - name: Deploy to Play Store
    #   working-directory: hoang_lam_app/android
    #   run: bundle exec fastlane android beta
    #   env:
    #     BUILD_NUMBER: ${{ github.run_number }}

  ios_beta:
    name: iOS Beta (TestFlight)
    if: inputs.target == 'ios_beta' || inputs.target == 'both'
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.41.x'
        channel: 'stable'
        cache: true

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4'
        bundler-cache: true
        working-directory: hoang_lam_app

    - name: Install Apple certificate and provisioning profile
      env:
        APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        APPLE_PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        KEYCHAIN_PASSWORD: ${{ github.run_id }}
      run: |
        # Create temporary keychain
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        # Import certificate
        CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
        echo -n "$APPLE_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
        security import $CERTIFICATE_PATH -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security list-keychain -d user -s $KEYCHAIN_PATH

        # Install provisioning profile
        PP_PATH=$RUNNER_TEMP/profile.mobileprovision
        echo -n "$APPLE_PROVISIONING_PROFILE_BASE64" | base64 --decode -o $PP_PATH
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/

    - name: Get dependencies
      working-directory: hoang_lam_app
      run: flutter pub get

    - name: Generate code
      working-directory: hoang_lam_app
      run: dart run build_runner build --delete-conflicting-outputs

    - name: Build and upload to TestFlight
      working-directory: hoang_lam_app/ios
      run: bundle exec fastlane ios beta
      env:
        BUILD_NUMBER: ${{ github.run_number }}

    - name: Clean up keychain
      if: always()
      run: security delete-keychain $RUNNER_TEMP/app-signing.keychain-db
